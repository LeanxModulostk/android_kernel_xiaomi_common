name: GKI | DoraCore Kernel Build

on:
  workflow_dispatch:
    inputs:
      KERNEL_BRANCH:
        description: 'DoraCore Branch'
        required: true
        default: 'RebaseLean'
        type: choice
        options:
        - RebaseLean
        - lindroid
      KERNEL_GIT:
        description: 'Kernel Source Code'
        required: true
        default: 'https://github.com/LeanxModulostk/android_kernel_xiaomi_common/tree/RebaseLean.git'
      CLANG_PREBUILT:
        description: 'Custom Clang Prebuilt Git'
        required: true
        default: 'https://gitlab.com/vermouth/android_prebuilts_clang_host_linux-x86_clang-r536225.git'
      CLANG_BRANCH:
        description: 'Custom Clang Prebuilt Branch'
        required: true
        default: '14.0'
      BUILD_TARGET:
        description: 'Specify your Build Target (lindroid only KSU)'
        required: true
        default: 'KSU'
        type: choice
        options:
        - NonKSU
        - KSU
        - Both
      ANYKERNEL_GIT:
        description: 'AnyKernel3 Git'
        required: true
        default: 'https://github.com/dopaemon/Anykernel3.git'
      RELEASE:
        description: 'Status Release'
        required: true
        default: 'draft'
        type: choice
        options:
        - draft
        - prerelease
        - release

jobs:

  create_release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
      discussions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag
        id: set-tag
        run: echo "tag=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set-tag.outputs.tag }}
          name: DoraCore Build ${{ steps.set-tag.outputs.tag }}
          draft: ${{ github.event.inputs.RELEASE == 'draft' }}
          prerelease: ${{ github.event.inputs.RELEASE == 'prerelease' }}
          body: |
            Build: DoraCore Kernel For GKI Linux 5.10.y
            Linux: Linux 5.10.y
            Type: GKI
            Developer: @dopaemon
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: create_release
    runs-on: ubuntu-latest

    env:
      DEVICE: gki
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      contents: write
      discussions: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Environment
        run: |
          TARGET="${{ github.event.inputs.BUILD_TARGET }}"
          echo "BUILD_DATE=$(TZ=Asia/Ho_Chi_Minh date +'%Y-%m%d-%H%M')" >> $GITHUB_ENV
          cd $GITHUB_WORKSPACE
          sudo apt-get update
          sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler rename libelf-dev dwarves wget openjdk-8-jdk
          sudo wget -O /usr/bin/repo http://commondatastorage.googleapis.com/git-repo-downloads/repo
          sudo chmod +x /usr/bin/repo
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          mkdir -p android-kernel
          cd android-kernel

          repo init --depth=1 --u ${{ github.event.inputs.KERNEL_GIT }} -b manifest
          repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

          git clone -b build --single-branch https://github.com/dopaemon/android_kernel_xiaomi_common.git build
          rm -rf .git .github .repo common
          rm -rf ./build/_setup_env.sh
          wget -O ./build/_setup_env.sh https://raw.githubusercontent.com/dopaemon/android_kernel_xiaomi_common/refs/heads/master/.github/scripts/_setup_env.sh
          chmod +x ./build/_setup_env.sh

          git clone -b ${{ github.event.inputs.KERNEL_BRANCH }} --recurse-submodules --depth=1 --single-branch --no-tags --filter=blob:none ${{ github.event.inputs.KERNEL_GIT }} common

          git clone -b lineage-22.2 --single-branch --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_sm8450-modules.git sm8450-modules
          git clone -b lineage-22.2 --single-branch --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_sm8450-devicetrees.git sm8450-devicetrees

          if [ "$TARGET" != "Both" ]; then
            git clone -b master --depth=1 --single-branch ${{ github.event.inputs.ANYKERNEL_GIT }} AnyKernel3
          else
            git clone -b volume --depth=1 --single-branch ${{ github.event.inputs.ANYKERNEL_GIT }} AnyKernel3
          fi
          rm -rf AnyKernel3/.git

      - name: Cache Clang
        id: cache-clang
        uses: actions/cache@v4
        with:
          path: android-kernel/prebuilts-master/clang/host/linux-x86/clang-r416183b
          key: clang-${{ github.event.inputs.CLANG_BRANCH }}
          restore-keys: clang-

      - name: Clone Clang
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          git clone -b ${{ github.event.inputs.CLANG_BRANCH }} --depth=1 --single-branch ${{ github.event.inputs.CLANG_PREBUILT }} android-kernel/prebuilts-master/clang/host/linux-x86/clang-r416183b

      - name: Set up ccache
        run: |
          mkdir -p ~/.cache/bazel
          ccache --max-size=2G
          ccache --set-config=compression=true

      - name: Build Kernel (RebaseLean / KSU / NonKSU)
        if: github.event.inputs.KERNEL_BRANCH == 'RebaseLean'
        run: |
          set -e
          TARGET="${{ github.event.inputs.BUILD_TARGET }}"
          DEVICE="gki"

          cd android-kernel/common/
          git reset --hard HEAD
          rm -rf ../out/android12-5.10

          if [ "$TARGET" == "KSU" ] || [ "$TARGET" == "Both" ]; then
            echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          else
            echo "CONFIG_KSU=n" >> arch/arm64/configs/gki_defconfig
          fi

          (
            set +e
            cd ../
            CC='ccache' LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh -j$(nproc --all) || true
          )

          [ -f "../out/android12-5.10/dist/Image" ] || exit 1

          cd ../AnyKernel3
          cp ../out/android12-5.10/dist/Image ./Image

          if [ "$TARGET" == "KSU" ]; then
            ZIP="DoraCore-gki-KSU-5.10-${BUILD_DATE}.zip"
          elif [ "$TARGET" == "NonKSU" ]; then
            ZIP="DoraCore-gki-NonKSU-5.10-${BUILD_DATE}.zip"
          else
            ZIP="DoraCore-gki-5.10-${BUILD_DATE}.zip"
          fi

          zip -r9 "$ZIP" *
          mv "$ZIP" $GITHUB_WORKSPACE/

      - name: Build Lindroid Kernel
        if: github.event.inputs.KERNEL_BRANCH == 'lindroid'
        run: |
          set -e
          DEVICE="gki"

          cd android-kernel/common/
          git reset --hard HEAD
          rm -rf ../out/android12-5.10

          cd ../
          CC='ccache' LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh -j$(nproc --all) || true

          [ -f "../out/android12-5.10/dist/Image" ] || exit 1

          cd AnyKernel3
          cp ../out/android12-5.10/dist/Image ./Image
          ZIP="DoraCore-gki-LinDroid-5.10-${BUILD_DATE}.zip"

          zip -r9 "$ZIP" *
          mv "$ZIP" $GITHUB_WORKSPACE/

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create_release.outputs.tag }}
          files: DoraCore*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
